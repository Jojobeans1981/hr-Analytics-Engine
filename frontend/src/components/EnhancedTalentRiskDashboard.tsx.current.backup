import React, { useState, useEffect, useCallback } from 'react';
import './EmployeeDashboard.css';

// Define API base URL
// Enhanced Types
interface Employee {
  id: string;
  name: string;
  department: string;
  riskScore: number;
  createdAt: string;
  performanceRating?: number;
  engagementScore?: number;
  tenureMonths?: number;
  riskLevel: 'LOW' | 'MEDIUM' | 'HIGH';
}

interface DepartmentAnalysis {
  name: string;
  employeeCount: number;
  avgRiskScore: number;
  highRiskCount: number;
  mediumRiskCount: number;
  lowRiskCount: number;
  topRiskFactors: string[];
  suggestedInterventions: string[];
}

interface TrendData {
  timestamp: string;
  avgRiskScore: number;
  highRiskCount: number;
}

const EnhancedTalentRiskDashboard: React.FC = () => {
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const [departmentAnalysis, setDepartmentAnalysis] = useState<DepartmentAnalysis[]>([]);
  const [trends, setTrends] = useState<TrendData[]>([]);
  const [loadingRecommendations, setLoadingRecommendations] = useState<string | null>(null);
  const [aiRecommendations, setAiRecommendations] = useState<any[]>([]);
  const [selectedEmployeeName, setSelectedEmployeeName] = useState<string>("");

  // Fetch employees
  const fetchEmployees = useCallback(async () => {
    try {
      setLoading(true);
    const apiUrl = process.env.REACT_APP_API_URL;
        const response = await fetch(`${apiUrl}/api/employees`, {
        headers: { 'Content-Type': 'application/json' },
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
        id: emp.employeeId || emp._id,  // Use employeeId as id, fallback to _id
        name: emp.name,
        department: emp.department,
        riskScore: emp.riskScore,
        createdAt: emp.createdAt,
        performanceRating: emp.performanceRating,
        engagementScore: emp.engagementScore,
        tenureMonths: emp.tenureMonths,
        riskLevel: emp.riskLevel || 'LOW'  // Ensure riskLevel is set
      }));
      
      setEmployees(mappedEmployees);
      console.log('Employees data:', mappedEmployees);
      console.log('First employee:', mappedEmployees[0]);
      console.log('Employees data:', mappedEmployees);
      console.log('First employee:', mappedEmployees[0]);
      setError(null);
      console.log('Fetched and mapped', mappedEmployees.length, 'employees');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to fetch employees');
      console.error('Error fetching employees:', err);
    } finally {
      setLoading(false);
    }
  }, []);

  // Analyze departments
  const analyzeDepartments = useCallback((employees: Employee[]): DepartmentAnalysis[] => {
    const deptMap: Record<string, Employee[]> = {};
    
    // Group by department
    employees.forEach(emp => {
      if (!deptMap[emp.department]) {
        deptMap[emp.department] = [];
      }
      deptMap[emp.department].push(emp);
    });

    // Analyze each department
    return Object.entries(deptMap).map(([deptName, deptEmployees]) => {
      const total = deptEmployees.length;
      const avgRiskScore = total > 0 
        ? deptEmployees.reduce((sum, emp) => sum + emp.riskScore, 0) / total 
        : 0;
      
      const highRiskCount = deptEmployees.filter(e => e.riskLevel === 'HIGH').length;
      const mediumRiskCount = deptEmployees.filter(e => e.riskLevel === 'MEDIUM').length;
      const lowRiskCount = deptEmployees.filter(e => e.riskLevel === 'LOW').length;

      // Determine top risk factors (simplified logic)
      const topRiskFactors = [];
      const avgPerformance = deptEmployees.reduce((sum, e) => sum + (e.performanceRating || 3), 0) / total;
      const avgEngagement = deptEmployees.reduce((sum, e) => sum + (e.engagementScore || 70), 0) / total;
      const avgTenure = deptEmployees.reduce((sum, e) => sum + (e.tenureMonths || 24), 0) / total;

      if (avgPerformance < 3) topRiskFactors.push('Low Performance');
      if (avgEngagement < 70) topRiskFactors.push('Low Engagement');
      if (avgTenure < 12) topRiskFactors.push('Low Tenure');
      if (avgTenure > 60) topRiskFactors.push('Stagnation Risk');
      if (highRiskCount / total > 0.3) topRiskFactors.push('High Concentration of At-Risk Employees');

      // Suggested interventions based on department
      const interventionsByDept: Record<string, string[]> = {
        'Engineering': ['Technical mentorship programs', 'Architecture review sessions', 'Tech debt reduction initiatives'],
        'Marketing': ['Creative brainstorming sessions', 'Campaign post-mortems', 'Cross-functional project opportunities'],
        'Product': ['User feedback sessions', 'Roadmap co-creation workshops', 'Stakeholder alignment meetings'],
        'Sales': ['Commission structure review', 'Sales training refresh', 'Territory optimization analysis'],
        'Design': ['Design critique sessions', 'User research participation', 'Design system contribution opportunities'],
        'HR': ['Workload assessment surveys', 'Policy feedback sessions', 'DEI initiative leadership roles'],
        'Default': ['1-on-1 coaching sessions', 'Career path discussions', 'Skill development opportunities']
      };

      const suggestedInterventions = interventionsByDept[deptName] || interventionsByDept['Default'];

      return {
        name: deptName,
        employeeCount: total,
        avgRiskScore: parseFloat(avgRiskScore.toFixed(1)),
        highRiskCount,
        mediumRiskCount,
        lowRiskCount,
        topRiskFactors: topRiskFactors.length > 0 ? topRiskFactors : ['No major risk factors identified'],
        suggestedInterventions: suggestedInterventions.slice(0, 3) // Top 3 interventions
      };
    }).sort((a, b) => b.avgRiskScore - a.avgRiskScore); // Sort by highest risk first
  }, []);

  // Generate trend data (mock for now - would come from historical API)
  const generateTrends = useCallback((employees: Employee[]): TrendData[] => {
    // Mock trend data - in real app, this would come from historical API
    const now = new Date();
    return [
      { timestamp: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], avgRiskScore: 42, highRiskCount: 8 },
      { timestamp: new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], avgRiskScore: 45, highRiskCount: 10 },
      { timestamp: new Date().toISOString().split('T')[0], avgRiskScore: 48, highRiskCount: 12 },
    ];
  }, []);

  useEffect(() => {
    fetchEmployees();
  }, [fetchEmployees]);

  useEffect(() => {
    if (employees.length > 0) {
      setDepartmentAnalysis(analyzeDepartments(employees));
      setTrends(generateTrends(employees));
    }
  }, [employees, analyzeDepartments, generateTrends]);

  const highRiskCount = employees.filter(e => e.riskScore >= 60).length;
  console.log('Total employees:', employees.length);
  console.log('High risk count (riskScore >= 60):', highRiskCount);
  console.log('High risk employees:', employees.filter(e => e.riskScore >= 60).map(e => ({name: e.name, riskScore: e.riskScore})));
  const criticalDepartments = departmentAnalysis.filter(dept => dept.highRiskCount > 0);
  
  if (loading) {
    return <div className="loading">Loading predictive risk intelligence...</div>;
  }

  if (error) {
    return <div className="error">Error: {error}</div>;
  }

  return (
    <div className="talent-risk-dashboard">
      <h1>‚ö° Predictive Talent Risk Intelligence</h1>
      <p className="subtitle">Real-time risk assessment & preventive intervention planning</p>

      {/* Executive Summary */}
      <div className="executive-summary">
        <div className="summary-card critical">
          <h3>üö® Critical Alert</h3>
          <p>{highRiskCount} high-risk employees identified</p>
          <p>{criticalDepartments.length} departments require immediate attention</p>
        </div>
        <div className="summary-card trend">
          <h3>üìà Risk Trend</h3>
          <p>Risk score increased by 14% over 30 days</p>
          <p>High-risk employees: +4 since last month</p>
        </div>
        <div className="summary-card intervention">
          <h3>üõ°Ô∏è Preventive Measures</h3>
          <p>{departmentAnalysis.reduce((sum, dept) => sum + dept.suggestedInterventions.length, 0)} interventions recommended</p>
          <p>Estimated retention impact: 23-40% improvement potential</p>
        </div>
      </div>

      {/* Department Risk Analysis */}
      <div className="section">
        <h2>üéØ Department Risk Analysis</h2>
        <div className="department-grid">
          {departmentAnalysis.map(dept => (
            <div key={dept.name} className={`department-card ${dept.avgRiskScore > 60 ? 'high-risk' : dept.avgRiskScore > 40 ? 'medium-risk' : 'low-risk'}`}>
              <h3>{dept.name}</h3>
              <div className="dept-stats">
                <div className="stat">
                  <span className="label">Employees:</span>
                  <span className="value">{dept.employeeCount}</span>
                </div>
                <div className="stat">
                  <span className="label">Avg Risk:</span>
                  <span className="value">{dept.avgRiskScore}/100</span>
                </div>
                <div className="stat">
                  <span className="label">High Risk:</span>
                  <span className="value red">{dept.highRiskCount}</span>
                </div>
              </div>
              
              <div className="risk-factors">
                <strong>Top Risk Factors:</strong>
                <ul>
                  {dept.topRiskFactors.map((factor, idx) => (
                    <li key={idx}>{factor}</li>
                  ))}
                </ul>
              </div>

              <div className="interventions">
                <strong>Recommended Interventions:</strong>
                <ol>
                  {dept.suggestedInterventions.map((intervention, idx) => (
                    <li key={idx}>{intervention}</li>
                  ))}
                </ol>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* High-Risk Employees */}
      <div className="section">
        <h2>üö® High-Risk Employees</h2>
        <div className="employee-list">
          {employees.filter(e => e.riskScore >= 60).map(employee => (
            <div key={employee.id} className="employee-card high-risk">
              <h4>{employee.name}</h4>
              <p>Department: {employee.department}</p>
              <p>Risk Score: {employee.riskScore}/100</p>
              <p>Last Evaluation: {new Date(employee.createdAt).toLocaleDateString()}</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default EnhancedTalentRiskDashboard;// test comment
